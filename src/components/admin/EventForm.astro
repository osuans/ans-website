---
import type { CollectionEntry } from 'astro:content';

interface Props {
  event?: CollectionEntry<'events'>;
}

const { event } = Astro.props;
const isEditMode = event != null;

// Helper to format dates for <input type="date">
const formatDateForInput = (date: Date | undefined) => {
  return date ? date.toISOString().slice(0, 10) : '';
};
---
<form method="POST" enctype="multipart/form-data" action={isEditMode ? `/api/events/edit` : `/api/events/create`} class="bg-white p-8 rounded-lg shadow-md space-y-6 max-w-4xl mx-auto">
  {isEditMode && <input type="hidden" name="slug" value={event.slug} />}

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
      <input type="text" name="title" id="title" value={event?.data.title ?? ''} required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
    </div>
    <div>
      <label for="location" class="block text-sm font-medium text-gray-700">Location</label>
      <input type="text" name="location" id="location" value={event?.data.location ?? ''} required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
    </div>
    <div>
      <label for="date" class="block text-sm font-medium text-gray-700">Start Date</label>
      <input type="date" name="date" id="date" value={formatDateForInput(event?.data.date)} required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
    </div>
    <div>
      <label for="endDate" class="block text-sm font-medium text-gray-700">End Date (Optional)</label>
      <input type="date" name="endDate" id="endDate" value={formatDateForInput(event?.data.endDate)} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
    </div>
    <div>
      <label for="time" class="block text-sm font-medium text-gray-700">Time (e.g., 9:00 AM - 5:00 PM)</label>
      <input type="text" name="time" id="time" value={event?.data.time ?? ''} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
    </div>
    <div>
      <label for="image" class="block text-sm font-medium text-gray-700">
        Event Image {isEditMode && '(Leave blank to keep existing)'}
      </label>
      <input type="file" name="image" id="image" accept="image/*" required={!isEditMode} class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      {isEditMode && event.data.image && (
        <p class="mt-2 text-sm text-gray-600">Current image: <a href={event.data.image} target="_blank" class="text-blue-600 hover:underline">{event.data.image}</a></p>
      )}
    </div>
  </div>

  <div>
    <label for="summary" class="block text-sm font-medium text-gray-700">Summary</label>
    <textarea name="summary" id="summary" rows="3" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">{event?.data.summary ?? ''}</textarea>
  </div>

  <div>
    <label for="body" class="block text-sm font-medium text-gray-700">Main Content (Markdown)</label>
    <textarea name="body" id="body" rows="12" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm font-mono">{event?.body ?? ''}</textarea>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <div>
      <label for="tags" class="block text-sm font-medium text-gray-700">Tags (comma-separated)</label>
      <input type="text" name="tags" id="tags" value={event?.data.tags?.join(', ') ?? ''} class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
    </div>
    <div>
      <label for="registrationLink" class="block text-sm font-medium text-gray-700">Registration Link (Optional)</label>
      <input type="url" name="registrationLink" id="registrationLink" value={event?.data.registrationLink ?? ''} placeholder="https://example.com" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
    </div>
  </div>

  <div class="flex items-start gap-x-8">
    <div class="relative flex items-start">
      <div class="flex h-6 items-center">
        <input id="registrationRequired" name="registrationRequired" type="checkbox" checked={event?.data.registrationRequired} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
      </div>
      <div class="ml-3 text-sm leading-6">
        <label for="registrationRequired" class="font-medium text-gray-900">Registration Required</label>
      </div>
    </div>
    <div class="relative flex items-start">
      <div class="flex h-6 items-center">
        <input id="draft" name="draft" type="checkbox" checked={event?.data.draft} class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600">
      </div>
      <div class="ml-3 text-sm leading-6">
        <label for="draft" class="font-medium text-gray-900">Save as Draft</label>
      </div>
    </div>
  </div>

  <div class="border-t border-gray-200 pt-6 flex justify-end">
    <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded-md hover:bg-blue-700 transition-colors text-base font-medium">
      {isEditMode ? 'Update Event' : 'Create Event'}
    </button>
  </div>
</form>