---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageHeader from "../../components/Sections/PageHeader.astro";
import EventCard from "../../components/UI/EventCard.astro";
import { getCollection } from "astro:content";
import { isFutureDate, isPastDate, groupEventsBySemester } from "../../utils/dateUtils";
import { CONFIG } from "../../constants";

// Get all events
const allEvents = await getCollection("events", ({ data }) => {
  return import.meta.env.PROD ? !data.draft : true;
});

// Separate upcoming and past events
const upcomingEvents = allEvents.filter(event => isFutureDate(event.data.date))
                            .sort((a, b) => new Date(a.data.date).getTime() - new Date(b.data.date).getTime());

const pastEvents = allEvents.filter(event => isPastDate(event.data.date))
                        .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());

const groupedPastEvents = groupEventsBySemester(pastEvents);
---

<BaseLayout
  title="Events - American Nuclear Society at Ohio State"
  description="Explore upcoming technical seminars, facility tours, and professional development events hosted by ANS at Ohio State."
>
  <PageHeader
    title="Events"
    subtitle="Technical Seminars, Facility Tours, and Professional Development"
    backgroundImage="/uploads/events.jpg"
  />

  <!-- Calendar Subscription Banner -->
  <section class="py-6 bg-primary-600">
    <div class="container">
      <div class="flex flex-col md:flex-row items-center justify-center gap-4 text-center md:text-left">
        <div class="text-white">
          <p class="font-semibold text-lg">Stay up to date with our events</p>
          <p class="text-primary-100 text-sm">Subscribe to our calendar and never miss an event</p>
        </div>
        <a
          href={CONFIG.CALENDAR.ICS_URL}
          class="inline-flex items-center gap-2 bg-white text-primary-600 px-6 py-3 rounded-lg font-semibold hover:bg-primary-50 transition-colors shadow-md"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          Subscribe to Calendar
        </a>
      </div>
    </div>
  </section>

  <!-- Upcoming Events -->
  <section class="py-16">
    <div class="container">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Upcoming Events</h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Explore our upcoming technical seminars, networking events, and professional development opportunities
        </p>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {upcomingEvents.map((event) => (
          <EventCard
            title={event.data.title}
            image={event.data.image || CONFIG.DEFAULTS.EVENT_IMAGE}
            date={event.data.date}
            time={event.data.time}
            location={event.data.location}
            summary={event.data.summary}
            slug={event.slug}
            variant="upcoming"
          />
        ))}
      </div>
    </div>
  </section>
  
  <!-- Past Events -->
  <section class="py-16 bg-gray-50">
    <div class="container">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-bold mb-4">Event Archive</h2>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
          Browse our previous seminars, tours, and chapter activities
        </p>
      </div>

      {Object.keys(groupedPastEvents).length > 0 ? (
        <div id="accordion">
          {Object.entries(groupedPastEvents).map(([semester, events]) => (
            <div class="accordion-item mb-2">
              <button class="accordion-button w-full text-left bg-white p-4 rounded-lg shadow-sm hover:bg-gray-100 focus:outline-none">
                <h3 class="text-xl font-bold">{semester}</h3>
              </button>
              <div class="accordion-content p-4 bg-white rounded-b-lg hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  {events.map((event) => (
                    <EventCard
                      title={event.data.title}
                      image={event.data.image || CONFIG.DEFAULTS.EVENT_IMAGE}
                      date={event.data.date}
                      time={event.data.time}
                      location={event.data.location}
                      summary={event.data.summary}
                      slug={event.slug}
                      variant="past"
                      summaryLength={80}
                    />
                  ))}
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-12 bg-white rounded-lg shadow-sm">
          <p class="text-gray-600">No past events to display.</p>
        </div>
      )}
    </div>
  </section>
  
</BaseLayout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const accordion = document.getElementById('accordion');
    if (accordion) {
      const buttons = accordion.querySelectorAll('.accordion-button');
      buttons.forEach((button) => {
        button.addEventListener('click', (e) => {
          const target = e.currentTarget as HTMLElement;
          const content = target.nextElementSibling;
          if (content) {
            content.classList.toggle('hidden');
          }
        });
      });
    }
  });
</script>
